# 订单状态定时处理、来单提醒和客户催单

## 第一节 需求分析

1. 业务功能需求
   - **超时订单处理**：用户下单后 15 分钟未支付，系统自动取消订单；派送中订单若长时间未确认完成，每日凌晨 1 点自动更新为已完成状态。
   - **来单提醒**：用户支付成功后，商家端自动弹出待接单提示框并进行语音播报。
   - **客户催单**：用户支付后商家未及时接单，用户点击催单按钮，商家端触发语音播报和催单提示。
2. 核心技术选型
   - **Spring Task**：Spring 框架提供的定时任务调度工具，用于实现订单状态的定时自动处理，无需客户端请求触发。
   - **WebSocket**：实现客户端与服务端双向数据传输的协议，用于推送来单提醒和催单消息，支撑实时交互功能。
3. Spring Task 核心要点
   - **定位与作用**：属于 Spring 家族，用于按约定时间自动执行指定 Java 代码逻辑，适用于各类定时任务场景。
   - **典型应用场景**：信用卡 / 贷款还款短信提醒、火车票未支付订单自动取消、员工入职纪念日通知发送等。
   - **学习重点**：cron 表达式（定义任务触发时间，如间隔时长、特定日期时间执行）、入门案例（实现定时执行代码逻辑）。



## 第二节 Spring Task

**Spring Task 核心知识点**

- 框架定位

  - 属于 Spring 家族的**任务调度工具**，核心能力是按约定时间**自动执行**指定 Java 代码逻辑。
  - 与传统 “请求 - 响应” 模式的区别：无需客户端发送 HTTP 请求触发，程序主动、自动执行。

- 核心作用

  按照开发者设定的时间规则，自动执行业务代码，解决各类需要 “定时触发” 的业务场景。

  类比生活场景：手机闹钟，到设定时间自动响起，无需人工操作。

- 典型应用场景

  - 金融领域：信用卡 / 贷款还款日到期前，自动向用户发送短信提醒。
  - 票务系统：火车票下单后 45 分钟未支付，自动取消订单并释放余票。
  - 企业内部：每日检查员工入职纪念日，自动发送祝福通知。
  - 项目实操：苍穹外卖的超时订单取消、派送中订单自动完结。



#### 2.1 cron表达式

1. cron 表达式的作用

   cron 表达式是一个字符串，用于定义 Spring Task 定时任务的触发时间。

2. cron 表达式的语法结构

   - 由 **6 个或 7 个域** 组成，域之间用空格分隔，**顺序固定**。
   - 7 个域的顺序（从左到右）：`秒 分 时 日 月 周 年`；其中 **年是可选域**，省略后即为 6 个域。

3. 核心域的特殊规则（日与周互斥）

   - 日（指定具体日期）和周（指定星期几）**不能同时有具体值**，其中一个指定具体内容时，另一个需要用 `?` 表示不指定。
   - 示例：描述 2022 年 10 月 12 日 上午 9 点整，表达式为 `0 0 9 12 10 ? 2022`。因为指定了日为 12，所以周的位置用 `?` 占位。

4. cron 表达式的特殊字符与用法

   除了直接填写数字，cron 表达式支持特殊字符实现灵活的时间配置，视频中提到的关键用法如下：

   | 字符 / 写法           | 作用                                | 示例                                                         |
   | --------------------- | ----------------------------------- | ------------------------------------------------------------ |
   | `*`                   | 通配符，表示 “每”                   | 秒域写 `*` 代表每秒触发                                      |
   | `x-y`                 | 表示时间范围，从 x 到 y             | 秒域写 `5-10` 代表第 5~10 秒触发                             |
   | `x/y`                 | 表示从 x 开始，每隔 y 个单位触发    | 秒域写 `0/5` 代表从 0 秒开始，每隔 5 秒触发                  |
   | `?`                   | 占位符，用于日 / 周互斥时的非指定域 | 日指定为 12，周写 `?`                                        |
   | `LW` 相关（视频提及） | 日域的特殊用法                      | 日域写 `10W` 代表 10 号附近最近的工作日；日域写 `L` 代表当月最后一天 |
   | `数字L`               | 周域的特殊用法                      | 周域写 `1L` 代表当月最后一个周一                             |

5. cron 表达式的便捷生成方式

   - 手动编写复杂 cron 表达式容易出错，推荐使用 **cron 表达式在线生成器**。
   - 生成器界面与 cron 表达式的域一一对应，可通过勾选、选择的方式配置秒、分、时等规则，自动生成对应的表达式，降低编写难度。



## 第三节 订单状态的定时处理

1. 业务需求场景

   - 场景一：待支付订单超时取消

     用户下单后需在 15 分钟内完成支付，若超时未支付，系统需自动将订单状态改为 “已取消”。

   - 场景二：派送中订单超时完成

     若用户已收货，但商家管理端未手动确认完成，订单会长期处于 “派送中” 状态，需系统自动处理为 “已完成”。

2. 定时任务触发策略（基于 Spring Task）

   定时任务的执行频率和时间需结合业务时效性和系统性能来设计：

   - 待支付订单处理：每分钟执行一次

     原因：需保证 15 分钟超时规则的时效性，若执行频率过低（如每天一次）会失去超时意义；若频率过高（如每秒一次）会增大系统和数据库压力。

   - 派送中订单处理：每天凌晨 1 点执行一次

     原因：派送状态无需高时效性，凌晨执行可避开业务高峰期，减少对系统的影响；若在白天（如中午）执行，可能误将正在派送的订单标记为完成。

3. 技术特点

   - 该功能基于**Spring Task 框架**实现，通过 cron 表达式配置任务触发规则。
   - 属于后台自动执行的业务逻辑，**无需前端发送 HTTP 请求触发**，因此不需要设计接口。



## 第四节 WebSocket

### 一、WebSocket 基础概念

1. 定义

   WebSocket 是基于 TCP 的一种新的网络协议，与 HTTP 协议同属于应用层协议，但设计目标和通信模式不同。

2. 核心特点

   实现浏览器与服务器的全双工通信：

   - 客户端与服务器只需完成**一次握手**，就能建立**持久性的长连接**。
   - 连接建立后，浏览器和服务器可**双向主动传输数据**，无需由客户端发起请求才能获取响应。

![image-20251212174423106](C:\Users\Silence\AppData\Roaming\Typora\typora-user-images\image-20251212174423106.png)

### 二、WebSocket 与 HTTP 协议的对比

|   特性   |                          HTTP 协议                           |              WebSocket 协议              |
| :------: | :----------------------------------------------------------: | :--------------------------------------: |
| 连接类型 |                短连接，请求响应完成后连接断开                |    长连接，握手后保持连接直至主动关闭    |
| 通信方向 | 单向通信，**客户端主动请求 → 服务器被动响应**，服务器无法主动推送 | 双向通信，客户端和服务器均可主动发送数据 |
| 交互模式 |                       请求 - 响应模式                        |                全双工模式                |
| 底层支撑 |                        基于 TCP 协议                         |              基于 TCP 协议               |

### 三、WebSocket 的典型应用场景

视频中列举了 4 类需要**实时数据交互**的场景：

1. **视频弹幕**：弹幕无需刷新页面即可实时出现在视频界面，由服务器主动推送给所有观看用户。
2. **网页聊天**：客服与用户的实时对话，双方消息可即时推送，无需手动刷新获取。
3. **体育实况更新**：赛事比分、技术统计等数据实时更新，服务器主动推送最新数据到前端。
4. **股票基金报价**：金融数据实时波动，页面无需请求即可同步最新行情。

### 四、WebSocket 交互流程演示

视频通过一个简单案例展示了 WebSocket 的工作流程：

1. **握手建立连接**：客户端（浏览器）向服务器发送握手请求，请求协议为 `ws`（WebSocket 缩写），而非 `http`。
2. 双向数据传输
   - 服务器通过定时任务，**每隔 5 秒主动向客户端推送消息**，客户端页面实时展示。
   - 客户端也可主动输入消息发送给服务器，服务器接收并处理。
3. **调试验证**：通过浏览器 F12 开发者工具，可在网络面板中看到 `ws` 协议的连接请求，以及双向传输的消息记录（服务器推送消息箭头为 “从上到下”，客户端发送消息箭头为 “从下到上”）。



第五节 spring整合websocket

1. 依赖准备

   

   项目需导入

    

   ```
   spring-boot-starter-websocket
   ```

    

   的 Maven 坐标，这是 SpringBoot 整合 WebSocket 的核心依赖。

2. 核心组件：WebSocket 服务端类

   - 类上添加 `@Component` 注解，交给 Spring 容器管理；添加 `@ServerEndpoint("/ws/{sid}")` 注解，指定服务端的通信路径，其中 `{sid}` 是用于区分不同客户端的动态路径参数。
   - 定义 `Map` 集合存储每个客户端对应的 `Session` 对象（`Session` 是 WebSocket 会话对象，代表客户端与服务端的连接），实现对不同客户端的管理。
   - 核心回调方法（通过注解标识，由 WebSocket 框架自动触发）：
     - `@OnOpen`：客户端与服务端**建立连接时**触发，方法内将当前客户端的 `Session` 存入 `Map`。
     - `@OnMessage`：服务端**接收客户端消息时**触发，类似 Controller 的请求处理方法，可获取客户端发送的消息内容。
     - `@OnClose`：客户端与服务端**断开连接时**触发，方法内将该客户端的 `Session` 从 `Map` 中移除，清理资源。
   - 自定义群发方法 `sendToAllClient`：遍历 `Map` 中的所有 `Session`，调用 `session.getBasicRemote().sendText()` 方法，向所有连接的客户端推送消息。

3. 配置类注册

   创建 WebSocket 配置类，添加

   ```
   @Configuration
   ```

   注解，通过配置

   ```
   ServerEndpointExporter
   ```

   实例，让 Spring 容器识别并注册

   ```
   @ServerEndpoint
   ```

   标识的 WebSocket 服务端组件。

4. 测试：定时任务群发消息

   导入定时任务类，添加

   ```
   @Component
   ```

   和

   ```
   @EnableScheduling
   ```

   （若主类未添加），注入 WebSocket 服务端组件。

   定义定时方法（如

   ```
   @Scheduled(fixedRate = 5000)
   ```

   ），每隔 5 秒调用群发方法，向所有客户端推送消息，验证服务端主动推消息的功能。

5. WebSocket 核心特点

   基于 TCP 协议，支持前后端双向通信，客户端可主动发消息给服务端，服务端也可主动推消息给客户端，无需客户端轮询请求。



## 第五节 来单提醒



## 第六节 Apache POI

1. Apache POI 核心定位

   - 它是一个**开源项目**，主要用于在 Java 程序中操作微软 Office 系列文档（Word、Excel、PowerPoint 等）。

   - 实际开发中，

     最常用场景是操作 Excel 文件，核心操作分为两类：

     - **读**：读取 Excel 文件中的数据内容。
     - **写**：向 Excel 文件中写入数据内容。

2. Apache POI 典型应用场景

   - **银行网银系统导出交易明细**：将用户的交易数据通过 POI 写入 Excel 文件，提供下载功能。
   - **业务系统导出报表数据**：例如订单统计报表，把业务系统中的统计数据生成 Excel 报表。
   - **批量导入业务数据**：读取 Excel 中预先录入的批量数据（如学生信息、员工信息），并导入到业务系统的数据库中。

3. **入门案例演示**

- 视频中展示了一个

  Excel 读操作案例

  1. 准备一个存放姓名、爱好数据的 Excel 文件（`it cos.xlsx`）。
  2. 通过 Java 程序调用 POI 相关 API 读取该文件内容。
  3. 将读取到的数据输出到控制台，验证 POI 读操作的效果。

第七节 导出excel报表

1. 报表的两种表现形式

   - **可视化图形报表**：之前课程中基于 ECharts 实现的折线图、柱形图等，用于直观展示数据趋势。
   - **Excel 表格报表**：本次要开发的功能，用于数据存档和详细统计，方便外卖商家查看核心运营数据。

2. 导出运营数据 Excel 报表的需求

   - **功能触发**：在数据统计页面点击 “数据导出” 按钮，即可下载 Excel 文件。

   - **数据范围**：导出最近 30 天的运营相关数据。

   - 报表格式

     ：格式固定，分为两部分

     - **概览数据**：包含营业额、订单完成率、新增用户数等核心指标。
     - **明细数据**：支撑概览数据的具体明细内容。

   - **业务价值**：为外卖商家提供营业状况的核心数据，便于商家分析经营情况、存档数据。

3. 接口设计规则

   - **请求方式**：采用 `GET` 方式，因为该操作是查询统计数据，无数据提交修改。
   - **请求参数**：无参数，后端自行计算最近 30 天的时间范围。
   - **请求路径**：`/report/export`（`export` 对应 “导出” 语义）。
   - **返回数据**：无 JSON 格式数据返回，本质是**文件下载**，服务端通过输出流将 Excel 文件直接写入客户端浏览器。

4. 该接口的特殊性

   - 与之前接口的区别：此前接口均返回 JSON 格式数据，而本接口是直接输出文件流，实现 Excel 文件的下载功能